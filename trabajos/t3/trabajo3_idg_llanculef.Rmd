---
title: "Agrupamiento de Zonas Censales en el Gran Santiago: Análisis Socio-Espacial de Viviendas Precarias e Ingreso Mediante K-Means"
author: "Diego Ñanculef"
date: "2025-06-29"
output: html_document
---

## 1. Introducción

El siguiente informe tiene como objetivo principal aplicar técnicas de agrupamiento (clustering) para clasificar las zonas censales urbanas del Gran Santiago. Este análisis se fundamenta en la utilización de variables microsimuladas, buscando identificar patrones territoriales latentes que permitan una comprensión más profunda de las dinámicas socio-espaciales de la ciudad.

En el contexto de la desigualdad urbana, la vivienda precaria emerge como una dimensión estructural clave, reflejando no solo condiciones habitacionales deficitarias sino también la convergencia de múltiples determinantes sociales como la seguridad, el acceso a servicios básicos y la conectividad. En el Trabajo 2, se realizó una microsimulación espacial de esta variable, identificando su distribución y concentración en ciertas comunas periféricas del sur y poniente de Santiago, lo cual es coherente con patrones históricos de asentamientos informales y urbanización marginal.

Para enriquecer este análisis y dotar de mayor profundidad a la clasificación territorial, la variable utilizada en el trabajo anterior "V1" (vivienda_precaria) ha sido complementada con la mediana de ingreso per cápita, también obtenida mediante microsimulación y validada en el contexto de este curso. La selección de esta variable de ingreso se justifica plenamente debido a su relevancia intrínseca en el patrón espacial de la precariedad habitacional. Diversas investigaciones y los resultados previos del Trabajo 2 han demostrado una correlación directa entre el tipo de vivienda y el nivel de ingreso: las zonas con mayor proporción de viviendas precarias o informales suelen estar asociadas a ingresos significativamente más bajos, mientras que las viviendas de alta calidad se concentran en sectores de altos ingresos.

La combinación de ambas variables permite ir más allá de la mera descripción de la precariedad para revelar tipologías de zonas que distinguen entre, por ejemplo, áreas de bajo ingreso con presencia de precariedad de vivienda y áreas de bajo ingreso donde esta condición no se observa, proporcionando así una visión más matizada de las realidades urbanas.

Metodológicamente, el trabajo implicará la determinación del número óptimo de grupos mediante el método del codo, la aplicación del algoritmo K-means para la agrupación de las zonas censales y la asignación de etiquetas significativas a cada clúster mediante un análisis estadístico de sus características promedio.

Finalmente, se generarán visualizaciones espaciales a través de mapas temáticos para ilustrar la distribución de estos clusters en el Gran Santiago, así como un mapa adicional que refleje la variabilidad intra-comunal de los clusters utilizando el Índice de Shannon. Se espera que este análisis permita una interpretación territorial profunda de los resultados, reflexionando sobre su coherencia con trabajos anteriores y su utilidad práctica para la planificación urbana y la formulación de políticas públicas.

## 2. Carga de librerías y conexión a Base de Datos

Esta sección establece el entorno computacional necesario para el análisis y prepara el conjunto de datos que será utilizado. Inicialmente, se procede con la carga de las librerías de R pertinentes, incluyendo herramientas para la manipulación y transformación de datos, el manejo de objetos espaciales, la aplicación de algoritmos de clustering, la visualización de datos, y la gestión de bases de datos.

Posteriormente, se establece una conexión directa con la base de datos PostgreSQL, que alberga la información censal y espacial requerida.

```{r Librerias, echo=TRUE, message=FALSE, warning=FALSE}
# INSTALAR TODAS LAS LIBRERIAS SOLO 1 VEZ
# =============================================================================
# Estos paquetes permiten conexión a BD, manejo de geometrías y visualización
# install.packages(c("DBI", "RPostgres", "sf", "ggplot2", "tidyverse", "cluster", "viridis", "factoextra", "vegan", "entropy", "GGally", "tibble", "tidyr"))

# =============================================================================
# Cargar librerías necesarias
library(tidyverse)
library(sf)
library(cluster)
library(factoextra)
library(ggplot2)
library(viridis)
library(DBI)
library(RPostgres)
library(GGally)   # Para ggpairs
library(entropy)  # Para el índice de Shannon
library(vegan)    # Alternativa para el índice de Shannon (aunque entropy ya sirve)
library(tibble)   # Para crear tibbles, útil para las etiquetas de clusters
library(tidyr)    # Para pivot_wider

# Configurar parámetros de conexión a la base de datos
db_host     = "localhost"
db_port     = 5432
db_name     = "censo_rm_2017"
db_user     = "postgres"
db_password = "postgres"

# Establecer conexión usando RPostgres
con = dbConnect(
  Postgres(),
  dbname    = db_name,
  host      = db_host,
  port      = db_port,
  user      = db_user,
  password = db_password
)
```

# 3. Carga y preparación de datos

A través de consultas SQL específicas, se extraen las variables clave para este estudio: el porcentaje de vivienda_precaria (derivado de la microsimulación del Trabajo 2) y la mediana_ingreso per cápita (variable microsimulada en clase). Ambas series de datos, asociadas a sus respectivos geocodigos de zona censal, son subsiguientemente unificadas en un único dataframe. Durante este proceso de preparación, se realiza un filtrado inicial para asegurar la integridad y consistencia del conjunto final, excluyendo aquellas zonas censales que presenten valores nulos (NAs) en estas variables seleccionadas, lo que garantiza la calidad del insumo para las etapas posteriores del análisis de agrupamiento.

```{r Datos de entrada, echo=FALSE}
# Consulta SQL para obtener la variable de vivienda precaria
sql_vivienda_precaria <- "
SELECT
  geocodigo::double precision AS geocodigo,
  vivienda_precaria
FROM dpa.zonas_v1;
"
df_vivienda_precaria <- dbGetQuery(con, sql_vivienda_precaria) %>%
  mutate(vivienda_precaria = replace_na(vivienda_precaria, 0))

# Consulta SQL para obtener la mediana de ingreso
sql_ingreso <- "
SELECT
  geocodigo::double precision AS geocodigo,
  mediana_ingreso
FROM dpa.tmp_ingreso_rm;
"
df_ingreso <- dbGetQuery(con, sql_ingreso)

# Unir las variables en un solo dataframe
df_clusters <- df_ingreso %>%
  left_join(df_vivienda_precaria, by = "geocodigo") %>%
  # Asegurarse de filtrar cualquier NA en las variables clave antes de escalar
  filter(!is.na(mediana_ingreso) & !is.na(vivienda_precaria))
```

# 4. Exploración de Datos

Esta parte es fundamental para comprender las características inherentes de las variables que serán utilizadas en el proceso de agrupamiento. En esta sección, se presenta un análisis descriptivo centrado en la distribución de la variable de % de viviendas precarias y la mediana de ingreso per cápita a través de histogramas. Este examen visual permite identificar patrones clave como la forma de la distribución (normal, sesgada), la presencia de valores atípicos, y la concentración de datos en ciertos rangos, como la notable acumulación de zonas con 0% de viviendas precarias. Los comentarios asociados a cada gráfico detallarán las observaciones más relevantes, como la asimetría de los datos de ingreso o la particular distribución de la precariedad de vivienda, sentando las bases para el preprocesamiento y la aplicación del algoritmo de clustering.

```{r Ajustes para mejor visualización, echo=FALSE}
# Calcular el porcentaje de zonas con 0% de vivienda precaria
porcentaje_ceros_vivienda_precaria <- mean(df_clusters$vivienda_precaria == 0, na.rm = TRUE) * 100

# === Histograma de vivienda_precaria para valores > 0 ===
# Esto permite ver la distribución de las zonas que SÍ tienen precariedad
ggplot(df_clusters %>% filter(vivienda_precaria > 0)) +
  geom_histogram(aes(x = vivienda_precaria), bins = 30, fill = "darkorange", color = "white") +
  theme_minimal() +
  labs(
    title = "Distribución de % viviendas precarias (solo zonas > 0%)",
    x = "% viviendas precarias",
    y = "Frecuencia"
  ) +
  annotate("text", x = Inf, y = Inf,
           label = paste0("Nota: ", round(porcentaje_ceros_vivienda_precaria, 2), "% de las zonas tienen 0% de viviendas precarias."),
           hjust = 1.05, vjust = 1.5, size = 3.5, color = "gray30")

# === Histograma de mediana_ingreso ===
ggplot(df_clusters) +
  geom_histogram(aes(x = mediana_ingreso), bins = 30, fill = "darkgreen", color = "white") +
  theme_minimal() +
  labs(
    title = "Distribución de la Mediana de Ingreso",
    x = "Mediana de Ingreso per cápita",
    y = "Frecuencia"
  )

```

Después de cada gráfico, añadir un breve comentario textual interpretando lo que se observa.

# 5. Agrupamiento (Clustering)

En esta sección se implementa el algoritmo de agrupamiento para clasificar las zonas censales urbanas de Santiago en grupos homogéneos, basándose en sus características de vivienda_precaria y mediana_ingreso. El proceso comienza con el escalado de las variables, un paso crítico para asegurar que ninguna de ellas domine el cálculo de distancias debido a diferencias en su escala original. Posteriormente, se procede a determinar el número óptimo de clusters (K), utilizando para ello el método del codo. Finalmente, se aplica el algoritmo K-means con el número de grupos establecido, lo que permitirá segmentar el territorio en distintas tipologías socio-residenciales para un análisis más profundo y la posterior interpretación de los patrones espaciales.

```{r Determinación del número óptimo de clusters (MÉTODO DEL CODO), echo=FALSE}
vars_scaled <- df_clusters %>%
  select(vivienda_precaria, mediana_ingreso) %>%
  scale()

# Método del codo para determinar número óptimo de clusters (Confirmado en 4)
fviz_nbclust(vars_scaled, kmeans, method = "wss") +
  labs(title = "Método del Codo para Vivienda Precaria e Ingreso", x = "Número de Clusters", y = "WSS") +
  theme_minimal()
# Se aplica K-MEANS y el ajuste para las etiquetas descriptivas
set.seed(123)

# Se ajusta 'centers' a 4 según lo obtenido en el método del codo
km <- kmeans(vars_scaled, centers = 4, nstart = 25)
df_clusters$cluster <- as.factor(km$cluster)
```

Comentario textual justificando la elección de K=4 basado en el gráfico del codo.

# 6. Caracterización y Etiquetado de los Grupos

## 6.1 Promedios de los Clusters

```{r}
# Resumen de los clusters para confirmación (Punto 11 en el código original)
cluster_summary <- df_clusters %>%
  group_by(cluster) %>%
  summarise(
    promedio_vivienda_precaria = mean(vivienda_precaria, na.rm = TRUE),
    promedio_ingreso = mean(mediana_ingreso, na.rm = TRUE),
    n_zonas = n()
  ) %>%
  arrange(promedio_vivienda_precaria) # Ordenar para una mejor interpretación
print(cluster_summary) # Para que la tabla se muestre en el output
```

## 6.2 Interpretación y Etiquetado Descriptivo

El etiquetado de los grupos (clusters) se realizó basándose en el análisis estadístico de sus características promedio en las variables de vivienda_precaria y mediana_ingreso. El algoritmo K-means agrupa las zonas que son similares entre sí en estas dos dimensiones. Una vez que se obtienen los clusters, se calcula la media de cada variable para cada grupo. Estas medias son las que permiten "entender" qué representa cada clúster y, por lo tanto, asignarle una etiqueta descriptiva.

-   Clúster 1 (n=2330 zonas): "Ingreso Medio-Bajo - Sin Precariedad"

Este es el grupo más grande y representa la norma en la provincia de Santiago. Su valor de promedio_vivienda_precaria es prácticamente 0% (0.00525%), indicando la ausencia casi total de precariedad de vivienda. Su promedio_ingreso (\$386,561) se sitúa en un rango medio-bajo en comparación con los otros clusters, lo que justifica la parte de "Ingreso Medio-Bajo".

-   Clúster 2 (n=212 zonas): "Ingreso Alto - Muy Baja/Casi Nula Precariedad"

Similar al Clúster 1 en cuanto a la casi nula precariedad de vivienda (0.00525%). Sin embargo, se distingue por tener un promedio_ingreso significativamente más alto (\$812,172), justificando la etiqueta de "Ingreso Alto".

-   Clúster 3 (n=16 zonas): "Alta Precariedad - Ingreso Medio-Bajo"

Este es el clúster más distintivo en términos de vivienda_precaria, con un promedio de 2.56%. A pesar de esta alta precariedad, su promedio_ingreso (\$391,164) es muy similar al del Clúster 1 (Ingreso Medio-Bajo). Esto es clave, ya que no son las zonas con los ingresos más bajos per se, sino que presentan un desafío particular de vivienda a pesar de un ingreso no extremo. Su reducido tamaño (16 zonas) indica que estas áreas son focos específicos.

-   Clúster 4 (n=308 zonas): "Ingreso Muy Alto - Sin Precariedad"

Este clúster se caracteriza por tener el promedio_ingreso más alto de todos (\$1,380,077). Al igual que los Clusters 1 y 2, su promedio_vivienda_precaria es 0%, lo que lo consolida como un grupo de alto bienestar en ambos aspectos.

En resumen, las etiquetas se derivan directamente de los patrones promedio que emergen en cada grupo, permitiendo una interpretación clara de las características socioeconómicas y habitacionales que los definen.

```{r Etiquetado descriptivo, echo=FALSE}
# Etiquetar los clusters de forma más descriptiva basandose en los promedios vistos en la tabla
cluster_labels_df <- tibble(
  cluster = factor(c(1, 2, 3, 4)),
  etiqueta_descriptiva = c(
    "1. Ingreso Medio-Bajo - Sin Precariedad",
    "2. Ingreso Alto - Muy Baja Precariedad",
    "3. Alta Precariedad - Ingreso Medio-Bajo",
    "4. Ingreso Muy Alto - Sin Precariedad"
  )
)

# Unir las etiquetas al dataframe principal para que ggplot las use en el mapa
df_clusters <- df_clusters %>%
  left_join(cluster_labels_df, by = "cluster")
```

# 7. Visualización de Resultados y Análisis Espacial

## 7.1 Carga de Geometrías y Unión de Datos

```{r}
#CARGA Y UNIÓN DE ZONAS CENSALES Y COMUNAS
sql_geom <- "
SELECT geocodigo::double precision AS geocodigo, geom, nom_comuna
FROM dpa.zonas_censales_rm
WHERE nom_provin = 'SANTIAGO' AND urbano = 1;
"
sf_zonas <- st_read(con, query = sql_geom)

# Unir los datos de clusters (con etiquetas descriptivas) con la geometría espacial
sf_mapa <- merge(sf_zonas, df_clusters, by = "geocodigo")

sql_comunas <- "
SELECT cut, nom_comuna, geom
FROM dpa.comunas_rm_shp
WHERE nom_provin = 'SANTIAGO';
"
sf_comunas <- st_read(con, query = sql_comunas)
bbox <- st_bbox(sf_mapa) # Usar el bbox de las zonas para el mapa principal
```

## 7.2 Gráfico de Dispersión de Clusters

```{r}
# Calcular estadísticas de los clusters para una mejor comprensión visual de los centros
cluster_summary_plot <- df_clusters %>%
  group_by(cluster) %>%
  summarise(
    avg_vivienda_precaria = mean(vivienda_precaria, na.rm = TRUE),
    avg_mediana_ingreso = mean(mediana_ingreso, na.rm = TRUE),
    etiqueta_descriptiva = first(etiqueta_descriptiva) # Para tener las etiquetas en el summary
  )

# Gráfico mejorado de Vivienda Precaria vs Ingreso (color por cluster)
ggplot(df_clusters, aes(x = vivienda_precaria, y = mediana_ingreso, color = cluster)) +
  geom_point(position = position_jitter(width = 0.05, height = 0), size = 2, alpha = 0.6) +
  # Añadir puntos medios de los clusters para ver el "centro" de cada grupo
  geom_point(data = cluster_summary_plot,
             aes(x = avg_vivienda_precaria, y = avg_mediana_ingreso, color = NULL), # color=NULL para que el asterisco sea negro por defecto
             size = 6, shape = 8, color = "black", stroke = 1.5,
             inherit.aes = FALSE) +
  labs(
    title = "Clusters de Vivienda Precaria e Ingreso",
    subtitle = "El símbolo '*' indica el centro promedio de cada cluster",
    x = "% Viviendas Precarias (con jitter para valores 0)",
    y = "Mediana de Ingreso per cápita"
  ) +
  scale_color_brewer(palette = "Set1", name = "Cluster") + # Aquí sigue mostrando 1,2,3,4 en la leyenda
  theme_minimal()
```
